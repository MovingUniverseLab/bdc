# bdc
Berkeley Distortion Calculator

This package matches star catalogues to a reference catalogue to calculate the geometric optical distortion.
The inputs are passed in a configuration file.
Run the code with:
python bdc_main.py config1.yml



YAML Configuration file:

nights : ['n1','n2']		# The script can handle data from several different observing runs, with potentially different 
							targets and parameters. These runs are called 'nights' in the script. The names in this list
							point to the sections later in the config file, and are used in naming outputs.

instrument : 'OSIRSIS'	# The instrument we are calculating a distortion model for. Currenly only handles 'OSIRIS'.

ref_instrument : 'Hubble'	# The reference frame that we are aligning the observations to. Currently only handles 'PCU' 
							and 'Hubble'.

legendre_order : 5			# The order of the Legendre polynomial that forms the final distortion model.

generate_new_fp : True 		# If True, will do the star matching and calculate four-parameter transformations, saving the 
							matches as a list. If False, will load this list from file. Used to quickly rerun the script to 
							generate plots.

fp_iterations : 5			# Sets the number of times that the four-parameter transformation is repeated in a loop, to
							 improve accuracy.

generate_reference_frame : False	# If False, will calculate a distortion solution by matching to the reference list. If 
									True, will generate a new reference list by combining the observations, and the final 
									distortion solution will be matched to that.

ref_iterations : 8			# Number of times to repeat the reference frame generation

centred : True 		# If True, will add a translation to the final result to set the distortion at the centre of 
							the frame to be zero. (This is an extra term, the Legendre polynomial is not changed) 

use_flystar_velocity  : False  		# If True, Flystar will be used to propogate the positions of the stars in the reference frame forward to the observation epoch using the velocities in the reference list. If False, the propogation is performed in this script.

manually_average_star_positions : True  #When generating a new reference frame, the positions of stars that appear in multiple frames are averaged. If this parameter if False, the average calculated by Flystar is used. If True, the average is calculated in this script (testing has shown no difference)

n1:  								# The name of the first 'night' of data. Must match an element from the parameter 'nights'.
  target        : 'M15'				# The name of the target. Currently the Ra, Dec, and observation epoch for 'M15' and 'M92' are hard coded.
  									#This needs to be changed. Instead pass the Ra, Dec, and Epoch? Can these be pulled from somewhere?
  nightDir      : '/u/mfreeman/work/d/n1/'          # Directories where things are. Needs to be changed. Do I need all these layers?
  cleanDir      : nightDir + 'clean/m15_kn3_tdOpen/'
  starfindDir   : cleanDir + 'starfinder/'          # The location of starlists generated by starfinder.
  stackDir      : cleanDir + 'stacks/'				# Not using stacked starlists? Could just do that in starfinder.
  bad_files     : ['ci200804_a022007_flip_0.8_stf.lis','ci200804_a026012_flip_0.8_stf.lis','ci200804_a027003_flip_0.8_stf.lis',]  #Normally all .lis files in starfindDir will we read in. Files in this list will not be included.
  mag_limits    : [6,16]							# Magnificaiton limits for the four-parameter matching.
  mag_tolerance : [2, 2, 2]							# Magnitude tolerance for the four-parameter matching.
  reference_file   : '/g/lu/data/m15/hst_ref/NGC7078cb.pm' #'je0o61lzq_flt.xymrduvqpk'    # The reference starlist.
  targetID      : 1745948323734090368   #gaia ID of target star. Ra and Dec used in prepare_gaia_for_flystar() Remove?
  ra_field      : 322.48999069			# Ra and Dec on the field of view. Used in some hard-coded alignment. Needs to be changed.
  dec_field     : 12.17453385
  # radius        : 20   #arcseconds    #was used to fetch GAIA data. Remove?
  minmag        : 15.4  #Magnitude 		# All stars in the observations fainter than this magnitude are discarded
  single_fit    : True  #run Mosaic2Ref for each image individually. Only works for true, delete?
  rad_tolerance : [0.4, 0.4, 0.2]       # Radius tolerance for the four-parameter matching
  dont_trim     : ['ci200804_a014004_flip_0.8_stf.lis', 'ci200804_a026009_flip_0.8_stf.lis']   # OSIRIS has noise in the edge 5 pixels of the frame, so any 'stars' detected here are discarded. This caused some problems for some images, so they were excluded from the trimming. Shouldn't be needed.
  slice         : [0,None]  			# A list with [start, stop, step] that is passed to a python slice object. You can optionally select a slice of the images to run on, instead of the full set.